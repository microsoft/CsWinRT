<Project ToolsVersion="14.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup Condition="'$(MSBuildProjectExtension)' == '.csproj'">
    <LangVersion>preview</LangVersion>
  </PropertyGroup>

  <PropertyGroup Condition="'$(MSBuildProjectExtension)' == '.csproj'" >
    <GeneratedFilesRootDir>$([MSBuild]::NormalizeDirectory('$(MSBuildProjectDirectory)', 'Generated Files'))</GeneratedFilesRootDir>
    <GeneratedFilesDir>$([MSBuild]::NormalizeDirectory('$(GeneratedFilesRootDir)', '$(TargetFramework)'))</GeneratedFilesDir>
  </PropertyGroup>

  <ItemGroup>
    <Compile Remove="$(GeneratedFilesRootDir)**/*.cs" />
    <None Include="$(GeneratedFilesRootDir)**/*.cs" />
    <Compile Condition="'$(GeneratedFilesDir)' != '$(GeneratedFilesRootDir)'" Include="$(GeneratedFilesDir)*.cs" />
  </ItemGroup>
	
  <ItemGroup>
    <FrameworkReference Remove="Microsoft.Windows.SDK.NET.Ref" />
    <FrameworkReference Remove="Microsoft.Windows.SDK.NET.Ref.Windows" />
    <FrameworkReference Remove="Microsoft.Windows.SDK.NET.Ref.Xaml" />
  </ItemGroup>

  <Import Condition="'$(MSBuildProjectExtension)' == '.csproj' and '$(SimulateCsWinRTNugetReference)' == 'true'" Project="..\nuget\Microsoft.Windows.CsWinRT.targets" />

  <Target Name="CsWinRTNet5EOL" />

  <Target Name="CsWinRTCheckDependencies" BeforeTargets="PrepareForBuild" Condition="'$(IsDotnetBuild)' != 'true'">
    <Error Condition="!Exists('$(SolutionDir)TestWinRT')" Text="This solution requires the TestWinRT repo, which is missing. Please run build.cmd from a Visual Studio command prompt." />
  </Target>

  <Target Name="CleanIntermediateDirs" Condition="'$(CleanIntermediateDirs)'=='true'" AfterTargets="Build">
    <RemoveDir Directories="$(IntDir)" />
  </Target>

  <!-- For C# projects, we use embedded pdbs, but we still need to submit symbols to the symbol server,
       so we extract the pdb to submit. -->
  <ItemGroup Condition="'$(MSBuildProjectExtension)' == '.csproj'">
    <PackageReference Include="Microsoft.DiaSymReader.Pdb2Pdb" PrivateAssets="All" GeneratePathProperty="true" />
  </ItemGroup>

  <Target Name="CopyEmbeddedSymbols" 
          AfterTargets="Build" 
          Condition="'$(MSBuildProjectExtension)' == '.csproj' and '$(TargetFramework)' != ''"
          Inputs="$(TargetPath)"
          Outputs="$(OutputPath)$(AssemblyName).pdb">
    <PropertyGroup>
      <_Pdb2PdbPath>$(PkgMicrosoft_DiaSymReader_Pdb2Pdb)\tools\Pdb2Pdb.exe</_Pdb2PdbPath>
      <_OutputPdbPath>$(OutputPath)$(AssemblyName).pdb</_OutputPdbPath>
      <_Pdb2PdbCommandLine>"$(TargetPath)" /out "$(_OutputPdbPath)" /extract</_Pdb2PdbCommandLine>
    </PropertyGroup>

    <!-- Delete existing extracted PDB to allow overwrite -->
    <Delete Files="$(_OutputPdbPath)" Condition="Exists('$(_OutputPdbPath)')" />

    <Exec Command="&quot;$(_Pdb2PdbPath)&quot; $(_Pdb2PdbCommandLine)" IgnoreExitCode="false" />

    <ItemGroup>
      <FileWrites Include="$(_OutputPdbPath)" />
    </ItemGroup>
  </Target>

</Project>
