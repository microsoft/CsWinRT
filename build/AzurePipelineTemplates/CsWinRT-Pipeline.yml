parameters:
- name: 'debug'
  displayName: 'Enable debug output'
  type: boolean
  default: false

variables:
- template: CsWinRT-Variables.yml@self
- template: CsWinRT-OneBranchVariables.yml
  parameters:
    debug: ${{ parameters.debug }}

name: $(MajorVersion).$(MinorVersion).$(PatchVersion)$(PrereleaseVersion).$(date:yyMMdd)$(rev:.r)

trigger: none 

pool:
  type: windows

resources:
  repositories:
  - repository: templates
    type: git
    name: OneBranch.Pipelines/GovernedTemplates
    ref: refs/heads/main
  - repository: TestWinRT
    type: github
    name: microsoft/TestWinRT
    endpoint: microsoft
    ref: '55224a29d80cdc08c79e1f13db0c8dd376c701b2'

extends:
  template: v2/Microsoft.Official.yml@templates
  parameters:
    platform:
      name: 'windows_undocked'
      product: 'build_tools'

    featureFlags:
      WindowsHostVersion:
        Version: 2022

    globalSdl:
      isNativeCode: true
      asyncSdl:
        enabled: true
      tsa:
        enabled: true
        useDynamicRouting: true
      codeql:
        compiled: 
          enabled: true
        tsaEnabled: true
      sbom:
        enabled: true
      prefast:
        enabled: true
      binskim:
        scanOutputDirectoryOnly: true

    nugetPublishing:
      feeds:
      - name: CsWinRT

    customTags: ES365AIMigrationTooling

    stages:
      - stage: BuildAndTest
        jobs: 
        - template: build/AzurePipelineTemplates/CsWinRT-BuildAndTest-Stage-OneBranch.yml@self

      - stage: Nuget
        dependsOn: BuildAndTest
        jobs:
        - template: build/AzurePipelineTemplates/CsWinRT-PublishToNuGet-Stage-OneBranch.yml@self